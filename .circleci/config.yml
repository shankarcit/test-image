# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
orbs:
  aws-eks: circleci/aws-eks@2.2.0
  kubernetes: circleci/kubernetes@1.3  
#  aws-cli: circleci/aws-cli@2.0.6
jobs:
  test-app:
    docker:
      - image: 'cimg/python:3.10' 
    parameters:
      cluster-name:
        description: |
          Cluster Name
        type: string
      aws-region:
        description: |
          AWS Region
        type: string           
    steps: 
      - aws-eks/update-kubeconfig-with-authenticator:
          cluster-name: << parameters.cluster-name >>
          aws-region: << parameters.aws-region >>
          install-kubectl: true
      - run:
          name: Build doc
          command: |         
            docker run --name demo-test -d -p 8080:80 056186925767.dkr.ecr.ap-northeast-1.amazonaws.com/ecr-shankar-tool-box/demo-app:edf93f6b-02ad-4cd5-b8f8-8e22dc0e4265
            sleep 100
            curl http://localhost:8080/

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  test-artifact:
    jobs:
      - test-app:
          cluster-name: k8s-dev-abc-demo
          aws-region: ap-northeast-1        

  
